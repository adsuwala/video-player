<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #303030;
            overflow: hidden;
        }
        cast-media-player {
            width: 100%;
            height: 100%;
            --splash-image: none;
            --theme-hue: 210;
            --progress-color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <cast-media-player></cast-media-player>
    
    <script>
        window.addEventListener('load', function() {
            const context = cast.framework.CastReceiverContext.getInstance();
            const playerManager = context.getPlayerManager();
            
            const playbackConfig = new cast.framework.PlaybackConfig();
            
            playbackConfig.manifestHandler = new cast.framework.PlaybackConfig.ManifestHandler();
            playbackConfig.useShakaForHls = true;
            playbackConfig.useShakaForDash = true;
            
            playbackConfig.shakaConfig = {
                streaming: {
                    bufferingGoal: 30,
                    rebufferingGoal: 2,
                    bufferBehind: 30
                },
                manifest: {
                    retryParameters: {
                        timeout: 30000,
                        maxAttempts: 3,
                        baseDelay: 1000,
                        backoffFactor: 2
                    }
                }
            };
            
            playerManager.setMessageInterceptor(
                cast.framework.messages.MessageType.LOAD,
                loadRequestData => {
                    console.log('Loading media:', loadRequestData.media?.contentId);
                    
                    if (loadRequestData.media) {
                        const url = loadRequestData.media.contentId;
                        
                        if (url.includes('.m3u8')) {
                            loadRequestData.media.contentType = 'application/x-mpegurl';
                            console.log('Detected HLS stream');
                        } else if (url.includes('.mpd')) {
                            loadRequestData.media.contentType = 'application/dash+xml';
                            console.log('Detected DASH stream');
                        }
                    }
                    
                    return loadRequestData;
                }
            );
            
            playerManager.addEventListener(
                cast.framework.events.EventType.ERROR,
                (event) => {
                    console.error('Playback error:', event.detailedErrorCode);
                }
            );
            
            context.start({
                playbackConfig: playbackConfig,
                supportedMediaCommands: cast.framework.messages.Command.ALL_BASIC_MEDIA,
                maxInactivity: 3600 
            });
            
            console.log('Receiver ready with Shaka Player');
        });
    </script>
</body>
</html>
